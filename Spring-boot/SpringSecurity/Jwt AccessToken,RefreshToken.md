#AccessToken과 RefreshToken에 관하여

* jwt 구조에 대한글은 아래링크를 참조해주시기 바랍니다.
>링크 [seonghoo1217'sTIL](https://github.com/seonghoo1217/TodayILearnd/blob/main/Spring-boot/SpringSecurity/SpringSecurity%EC%99%80%20Jwt.md)

Jwt는 기본적으로 사용자 인증정보가 담긴 토큰을 발급해 추후 인증 또는 인가가 필요한 리소스에 접근 시 사용자가 서버에 토큰을 포함하여서 전송하여주면
서버측에서는 인증절차를 보다 간단히 토큰하나로 처리할 수 있다. 그렇기 때문에 최근 Jwt에 대한 선호도가 높아지는것이다.
이 방법을 사용할때 서버는 보통 AccessToken이라 불리는 리소스 접근용 토큰을 사용한다. 이 Jwt는 Stateless한 방법이기 때문에 서버측에서 이 토큰
하나만으로 사용자의 정보를 신뢰할 수 없고 인증절차 또한 신뢰도가 떨어지게 된다.

이를 보완하고자 등장한 개념이 RefreshToken으로 사용자 인증을 맡는 액세스 토큰을 오로지 생성하는 역할만 맡게된다.
그럼 여기서 의문이 하나 들게된다. RefreshToken,굳이 왜 쓰는걸까?
현재 이 글은 구글링을 통한 공부이후 나혼자 정리 하는 글이지만 이 의문이 너무나도 강력하게들어 추가적인 구글링과 책을 읽어본 결과
JWT의 유출 이슈와 관련되어 있었다. JWT가 유출될 경우 RefreshToken은 다음과 같이 문제를 해결한다.

1. Access Token의 유효기간을 짧게 설정한다.

2. Refresh Token의 유효기간을 길게 설정한다.

3. 사용자는 Access Token과 Refresh Token을 둘다 서버로 전송하여 Access Token이 만료되었을 시에 새로운 Access Token을 발급받는다.

4. 이 과정에서 해커가 Access Token을 탈취하여도 유효기간이 짧기 때문에 타격이 크지않다.

5. 정상적으로 서비스를 이용한 클라이언트는 유효기간이 만료되어도 Refresh Token이 새로운 Access Token을 발급하여주기 때문에 서비스이용시 큰 문제가 되지 않는다.

이러한 구조덕에 토큰이 유출되더라도 피해를 최소화 할 수 있다. 또한 토큰이 탈취되어 검증 및 리소스를 파기하려고 하더라도 토큰의 유효기간 자체를 짧게 설정하여
피해를 2차적으로 방지할 수 있다. 하지만 정상적인 클라이언트도 짧은 주기마다 로그인을 다시하여 Access Token을 발급받아야하는 단점이있다.

그래서 Refresh Token의 유효기간을 길게 사용하고 정상적인 사용자는 서버쪽에 Request Token을 전송하여 다시 로그인 할 필요 없이 Access Token을 발급 받을 수 있다.

## 만약 Refresh Token이 탈취당한다면??

위와 같이 토큰의 중요성을 알게 되었지만 갑자기 Refresh Token이 탈취 당하면 정작 아무 소용 없는거아닌가? 라는 의문이들어 구글링을 해보았다.
이를 막기위해서 서버측에서는 검증 로직이 필요하고 그 흐름도는 다음과 같다.

1. 데이터베이스에 각 사용자에 1대1로 맵핑되는 Access Token, Refresh Token 쌍을 저장한다.

2. 정상적인 사용자는 기존의 Access Token으로 접근하며 서버측에서는 데이터베이스에 저장된 Access Token과 비교하여 검증한다.

3. 공격자는 탈취한 Refresh Token으로 새로 Access Token을 생성한다. 그리고 서버측에 전송하면 서버는 데이터베이스에 저장된 Access Token과 공격자에게 받은 Access Token이 다른 것을 확인한다.

4. 만약 데이터베이스에 저장된 토큰이 아직 만료되지 않은 경우, 즉 굳이 Access Token을 새로 생성할 이유가 없는 경우 서버는 Refresh Token이 탈취당했다고 가정하고 두 토큰을 모두 만료시킨다.

5. 이 경우 정상적인 사용자는 자신의 토큰도 만료됐으니 다시 로그인해야 한다. 하지만 공격자의 토큰 역시 만료됐기 때문에 공격자는 정상적인 사용자의 리소스에 접근할 수 없다.

