# Spring + SSE

현재 개발중인 프로젝트에서 실시간 성을 보장해야하는 기능이 필요하여, `WS(WebSocket)`을 적용하여, 구현하려했으나 기능 요구사항을 도출하는 과정에서 서버와 클라이언트간의
과할정도로 많다는 것을 깨달았다.

기능의 요구사항은 아래와 같았다.

- 실시간 음성 스트리밍을 위하여 Youtube API를 이용하여 유튜브 링크를 `iframe`을 통해서 재생한다.
    - 이때 스트리밍 서비스 특성상 시간 지점(point)를 조절하거나 일시정지등의 작업을 수행할 수 있다.
    - 이러한 부분들을 고려하였을 때 모든 사용자가 플레이어 조작에 관한 정보를 전달받아야하는 요구사항이 필수적으로 존재한다.
    - 해당 사항을 원래는 WebSocket의 `STOMP` 구조를 통하여 해결하려 했으나 클라이언트 측에서 1초단위로 서버에 현재 유튜브가 재생되고 있는 지점을 보내줘야함
        - 하지만 수십명이 존재하는 음악 방이 수십개가 있고 이것을 전부 소켓을 통해 해결하려한다면? 수많은 Connection으로 인한 서버 부하로 장애 발생우려

## 고려되었던 기술과의 차이점

`실시간 성`을 보장하 기술들은 몇개가 존재한다.

바로 `WebSocket`과 그 등장 이전에 사용하던 `Polling`이다.

간단하게 설명하자면 Polling의 경우 client 측에서 일정주기로 업데이트 요청 보내는 방법이지만 요청을 보낼때마다 Http Connection이 발생하기 때문에 좋은방법은 아니다.

WebSocket의 경우 HandShake를 통해 `클라이언트-서버` 간의 연결지을 수행하는 양방 통신방법이기 채팅이나 기본적인 스트리밍 관련 서비스에서 보편적으로 사용된다.

## 그렇다면 SSE는요?
이벤트의 발생이 Server->Client 식으로 단방 통신을 수행하는 채널이다.

SSE는 클라이언트가 polling과 같이 주기적으로 http 요청을 보낼 필요없이 http 연결을 통해 서버에서 클라이언트로 데이터를 보낼 수 있다.

**🧐그렇다면 왜 SSE여야만 했는가?**

우선적으로 매 요청과 응답 사이클마 다시 Request(요청)이 발생하는 Polling 구조는 리소스를 많이 잡아먹는다.

또한 웹 소켓을 사용하여 구현이 충분히 가능한 부분도 맞지만, 이과정에서 계속해서 발생하는 요청은 확실하게 서버에 부담이었다.

그렇기 때문에 Server-Send-Events를 사용하기로 결정하였다.

## SSE 통신 구조

![SSE](https://tecoble.techcourse.co.kr/static/c9d3a25dbd760dd65d96cdb48af73160/ffe51/sse2.png)

구조자체는 WebSocket의 `3-Hand-Shake`와 크게 다르지 않다.

1. 최초로 Client에서 서버의 이벤트를 구독한다.
- 이때, 반환되는 이벤트 미디어 타입은 `text/event-stream`이 표준으로 지정되어 있다.

2. 구독된 정보를 파악한후 Server 비동기 방식을 통 해당클라이언트에 데이터를 전송할 수 있다.
    - 이때 전송되는 데이터는 `Key:Value` 형태로 데이터를 전달한다.

## SSE 통신 흐름
1. 클라이언트에서 SSE 연결 요청을 연다
2. 서버에서는 해당 요청을 기반으 SSE 통신 객체를 생성한다.
3. 서버에 이벤트 발생시 해당 객체를 통해 클라이언트에게 값을 전달

![sse2](https://tecoble.techcourse.co.kr/static/07d241cd25a664abebd2e6ce4154af70/a7a60/sse3.png)

![sse3](https://tecoble.techcourse.co.kr/static/cda947189eb317f424fdbcae6a969fe9/973af/sse4.png)

## SSE 특징
- WS와 달리 별도의 프로토콜을 사용하지 않고 HTTP 프로토콜만으로 사용이 가능하며 훨씬 가볍다.
- 접속에 문제가 있으면 자동으로 재연결을 시도한다.
- 최대 동시 접속 수는 HTTP/1.1의 경우 브라우저 당 6개이며, HTTP/2는 100개까지 가능하다.
- IE를 제외한 브라우저에서 지원된다.
- 이벤트 데이터는 UTF-8 인코딩된 문자열만 지원한다. 일반적으로 JSON으로 마샬링하여 전송한다.
- 단점으로는, 클라이언트에서 페이지를 닫아도 서버에서 감지하기가 어렵다.(불필요한 자원낭비 가능성)

## SSE in Spring
보통적으로 `SseEmitter` 또는 `Webflux`를 통해 구현한다.

